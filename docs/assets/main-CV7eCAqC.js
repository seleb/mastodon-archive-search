import{get as E,set as j}from"./Storage-DMVpVoiH.js";import{e as k}from"./index-Cd71Ev1u.js";var D=function(){function c(){}var i=c.prototype;return i.expandToken=function(e){for(var l=[],d="",u=0,h=e.length;u<h;++u)d+=e.charAt(u),l.push(d);return l},c}(),L=function(){function c(){}var i=c.prototype;return i.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},c}();function z(c,i){i=i||[],c=c||{};for(var t=c,e=0;e<i.length;e++)if(t=t[i[e]],t==null)return null;return t}var N=function(){function c(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var i=c.prototype;return i.indexDocument=function(e,l,d){this._tokenToIdfCache={};var u=this._tokenMap,h;typeof u[e]!="object"?u[e]=h={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(h=u[e],h.$totalNumOccurrences++);var m=h.$uidMap;typeof m[l]!="object"?(h.$numDocumentOccurrences++,m[l]={$document:d,$numTokenOccurrences:1}):m[l].$numTokenOccurrences++},i.search=function(e,l){for(var d={},u=0,h=e.length;u<h;u++){var m=e[u],_=this._tokenMap[m];if(!_)return[];if(u===0)for(var v=Object.keys(_.$uidMap),p=0,g=v.length;p<g;p++){var r=v[p];d[r]=_.$uidMap[r].$document}else for(var v=Object.keys(d),p=0,g=v.length;p<g;p++){var r=v[p];typeof _.$uidMap[r]!="object"&&delete d[r]}}var s=[];for(var r in d)s.push(d[r]);var o=this._createCalculateTfIdf();return s.sort(function(n,a){return o(e,a,l)-o(e,n,l)})},i._createCalculateIdf=function(){var e=this._tokenMap,l=this._tokenToIdfCache;return function(u,h){if(!l[u]){var m=typeof e[u]<"u"?e[u].$numDocumentOccurrences:0;l[u]=1+Math.log(h.length/(1+m))}return l[u]}},i._createCalculateTfIdf=function(){var e=this._tokenMap,l=this._uidFieldName,d=this._createCalculateIdf();return function(h,m,_){for(var v=0,p=0,g=h.length;p<g;++p){var r=h[p],s=d(r,_);s===1/0&&(s=0);var o;l instanceof Array?o=m&&z(m,l):o=m&&m[l];var n=typeof e[r]<"u"&&typeof e[r].$uidMap[o]<"u"?e[r].$uidMap[o].$numTokenOccurrences:0;v+=n*s}return v}},c}(),O=/[^a-zа-яё0-9\-']+/i,H=function(){function c(){}var i=c.prototype;return i.tokenize=function(e){return e.split(O).filter(function(l){return l})},c}();function S(c,i){for(var t=0;t<i.length;t++){var e=i[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(c,e.key,e)}}function F(c,i,t){return i&&S(c.prototype,i),t&&S(c,t),c}var w=function(){function c(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new D,this._searchIndex=new N(t),this._sanitizer=new L,this._tokenizer=new H,this._documents=[],this._searchableFields=[]}var i=c.prototype;return i.addDocument=function(e){this.addDocuments([e])},i.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},i.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},i.search=function(e){var l=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(l,this._documents)},i.indexDocuments_=function(e,l){this._initialized=!0;for(var d=this._indexStrategy,u=this._sanitizer,h=this._searchIndex,m=this._tokenizer,_=this._uidFieldName,v=0,p=e.length;v<p;v++){var g=e[v],r;_ instanceof Array?r=z(g,_):r=g[_];for(var s=0,o=l.length;s<o;s++){var n,a=l[s];if(a instanceof Array?n=z(g,a):n=g[a],n!=null&&typeof n!="string"&&n.toString&&(n=n.toString()),typeof n=="string")for(var f=m.tokenize(u.sanitize(n)),y=0,b=f.length;y<b;y++)for(var x=f[y],T=d.expandToken(x),I=0,M=T.length;I<M;I++){var C=T[I];h.indexDocument(C,r,g)}}}},F(c,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),c}();function $(c,i,t){return c.replace(new RegExp(`(${i.map(e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),t)}(async()=>{const c=document.querySelector('input[type="file"]'),i=document.querySelector('input[type="search"]'),t=document.querySelector("select"),e=document.querySelector("#results"),l=document.querySelector("#stats");let d=null;if(!c||!i||!t||!e||!l)throw new Error("could not find elements");let u=new w("id");const h=r=>{var s;try{const o=r.orderedItems.filter(a=>a.type==="Create"&&typeof a.object!="string"&&a.object.type==="Note").map(a=>({...a,object:{...a.object,alt:a.object.attachment.map(f=>f.name).join("|")}}));if(!o.length)throw new Error("could not find any posts, double check that your outbox file is correct");const n=((s=o[o.length-1])==null?void 0:s.object.published)||0;l.innerHTML=`<span id="count">${o.length}</span> of ${o.length} posts, latest: <time datatime="${n}">${new Date(n).toDateString()}</time>`,d=document.querySelector("#count"),u=new w("id"),u.tokenizer={tokenize(a){return a.split(/\s/).filter(f=>f)}},u.addIndex(["object","content"]),u.addIndex(["object","summary"]),u.addIndex(["object","alt"]),u.addDocuments(o),j("outbox",r),i.value="",p()}catch(o){let n="unknown error";o instanceof Error&&(n=o.message),k("Failed to load outbox",o),e.innerHTML=`<li class="null error">Failed to load outbox: ${n||"unknown error"}</li>`}};function m(r,s){const o=[],n=/^\s*$/;function a(f){if(f.nodeType==3)(s||!n.test(f.nodeValue||""))&&o.push(f);else for(var y=0,b=f.childNodes.length;y<b;++y)a(f.childNodes[y])}return a(r),o}const _=(r,s)=>{r.forEach(o=>{const n=o.textContent,a=s(n||""),f=document.createRange().createContextualFragment(a);o.replaceWith(f)})},v=(r,s)=>{const o=u.tokenizer.tokenize(s);let n=m(r,!0);_(n,a=>$(a,[s],'<mark class="exact">$1</mark>')),n=m(r,!0),_(n,a=>$(a,o,"<mark>$1</mark>"))},p=()=>{try{const r=i.value;if(Array.from(e.children).forEach(n=>n.remove()),r.length<3){e.innerHTML='<li class="null">Search results will be displayed here</li>',d&&(d.textContent="0");return}const s=u.search(r);if(!s.length){e.innerHTML=`<li class="null">No results found for search "${r}"</li>`,d&&(d.textContent="0");return}const o=t.value;o==="latest first"?s.sort((n,a)=>a.published.localeCompare(n.published)):o==="oldest first"&&s.sort((n,a)=>n.published.localeCompare(a.published)),s.forEach(n=>{const a=document.createElement("li"),f=document.createElement("a");if(f.title="open original",f.href=n.object.id,f.target="_blank",f.rel="noreferrer nofollow noopener",a.innerHTML=n.object.content||"",v(a,r),n.object.attachment.forEach(b=>{const x=document.createElement("div");x.innerHTML=b.name||"",v(x,r),x.innerHTML=x.innerHTML||"Media with no provided descriptive text",a.appendChild(x)}),n.object.summary){const b=document.createElement("details"),x=document.createElement("summary");x.innerHTML=n.object.summary||"",v(x,r),b.innerHTML=a.innerHTML,a.textContent="",b.prepend(x),b.open=!0,a.appendChild(b)}const y=document.createElement("time");y.textContent=new Date(n.object.published).toDateString(),y.dateTime=n.object.published,f.appendChild(y),a.prepend(f),e.appendChild(a)}),d&&(d.textContent=s.length.toString(10))}catch(r){let s="unknown error";r instanceof Error&&(s=r.message),k("Failed to search",r),e.innerHTML=`<li class="null error">Failed to search: ${s||"unknown error"}</li>`}},g=E("outbox");g&&h(g),c.addEventListener("change",async()=>{var o;const r=(o=c.files)==null?void 0:o[0];if(!r)return;const s=JSON.parse(await r.text());h(s)}),i.addEventListener("input",p),t.addEventListener("change",p)})();
