import{get as E,set as j}from"./Storage-C-v-M-AW.js";import{e as z}from"./index-BEMjDm4i.js";var D=function(){function o(){}var a=o.prototype;return a.expandToken=function(e){for(var i=[],h="",l=0,d=e.length;l<d;++l)h+=e.charAt(l),i.push(h);return i},o}(),C=function(){function o(){}var a=o.prototype;return a.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},o}();function x(o,a){a=a||[],o=o||{};for(var t=o,e=0;e<a.length;e++)if(t=t[a[e]],t==null)return null;return t}var L=function(){function o(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var a=o.prototype;return a.indexDocument=function(e,i,h){this._tokenToIdfCache={};var l=this._tokenMap,d;typeof l[e]!="object"?l[e]=d={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(d=l[e],d.$totalNumOccurrences++);var m=d.$uidMap;typeof m[i]!="object"?(d.$numDocumentOccurrences++,m[i]={$document:h,$numTokenOccurrences:1}):m[i].$numTokenOccurrences++},a.search=function(e,i){for(var h={},l=0,d=e.length;l<d;l++){var m=e[l],u=this._tokenMap[m];if(!u)return[];if(l===0)for(var s=Object.keys(u.$uidMap),n=0,c=s.length;n<c;n++){var r=s[n];h[r]=u.$uidMap[r].$document}else for(var s=Object.keys(h),n=0,c=s.length;n<c;n++){var r=s[n];typeof u.$uidMap[r]!="object"&&delete h[r]}}var p=[];for(var r in h)p.push(h[r]);var v=this._createCalculateTfIdf();return p.sort(function(f,_){return v(e,_,i)-v(e,f,i)})},a._createCalculateIdf=function(){var e=this._tokenMap,i=this._tokenToIdfCache;return function(l,d){if(!i[l]){var m=typeof e[l]<"u"?e[l].$numDocumentOccurrences:0;i[l]=1+Math.log(d.length/(1+m))}return i[l]}},a._createCalculateTfIdf=function(){var e=this._tokenMap,i=this._uidFieldName,h=this._createCalculateIdf();return function(d,m,u){for(var s=0,n=0,c=d.length;n<c;++n){var r=d[n],p=h(r,u);p===1/0&&(p=0);var v;i instanceof Array?v=m&&x(m,i):v=m&&m[i];var f=typeof e[r]<"u"&&typeof e[r].$uidMap[v]<"u"?e[r].$uidMap[v].$numTokenOccurrences:0;s+=f*p}return s}},o}(),O=/[^a-zа-яё0-9\-']+/i,H=function(){function o(){}var a=o.prototype;return a.tokenize=function(e){return e.split(O).filter(function(i){return i})},o}();function k(o,a){for(var t=0;t<a.length;t++){var e=a[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(o,e.key,e)}}function N(o,a,t){return a&&k(o.prototype,a),t&&k(o,t),o}var T=function(){function o(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new D,this._searchIndex=new L(t),this._sanitizer=new C,this._tokenizer=new H,this._documents=[],this._searchableFields=[]}var a=o.prototype;return a.addDocument=function(e){this.addDocuments([e])},a.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},a.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},a.search=function(e){var i=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(i,this._documents)},a.indexDocuments_=function(e,i){this._initialized=!0;for(var h=this._indexStrategy,l=this._sanitizer,d=this._searchIndex,m=this._tokenizer,u=this._uidFieldName,s=0,n=e.length;s<n;s++){var c=e[s],r;u instanceof Array?r=x(c,u):r=c[u];for(var p=0,v=i.length;p<v;p++){var f,_=i[p];if(_ instanceof Array?f=x(c,_):f=c[_],f!=null&&typeof f!="string"&&f.toString&&(f=f.toString()),typeof f=="string")for(var I=m.tokenize(l.sanitize(f)),g=0,S=I.length;g<S;g++)for(var w=I[g],b=h.expandToken(w),y=0,M=b.length;y<M;y++){var $=b[y];d.indexDocument($,r,c)}}}},N(o,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),o}();(async()=>{const o=document.querySelector('input[type="file"]'),a=document.querySelector('input[type="search"]'),t=document.querySelector("#results"),e=document.querySelector("#stats");if(!o||!a||!t||!e)throw new Error("could not find elements");let i=new T("id");const h=u=>{var s;try{const n=u.orderedItems.filter(r=>r.type==="Create"&&typeof r.object!="string"&&r.object.type==="Note").map(r=>({...r,object:{...r.object,alt:r.object.attachment.map(p=>p.name).join("|")}}));if(!n.length)throw new Error("could not find any posts, double check that your outbox file is correct");const c=((s=n[n.length-1])==null?void 0:s.object.published)||0;e.innerHTML=`${n.length} posts, latest: <time datatime="${c}">${new Date(c).toDateString()}</time>`,i=new T("id"),i.addIndex(["object","content"]),i.addIndex(["object","summary"]),i.addIndex(["object","alt"]),i.addDocuments(n),j("outbox",u),a.value="",d("")}catch(n){let c="unknown error";n instanceof Error&&(c=n.message),z("Failed to load outbox",n),t.innerHTML=`<li class="null error">Failed to load outbox: ${c||"unknown error"}</li>`}},l=(u,s)=>{const n=i.tokenizer.tokenize(s);let c=u.replaceAll(s,`<mark class="exact">${s}</mark>`);return n.forEach(r=>{c=c.replaceAll(r,`<mark>${r}</mark>`)}),c},d=u=>{try{if(Array.from(t.children).forEach(n=>n.remove()),u.length<3){t.innerHTML='<li class="null">Search results will be displayed here</li>';return}const s=i.search(u);if(!s.length){t.innerHTML=`<li class="null">No results found for search "${u}"</li>`;return}s.forEach(n=>{const c=document.createElement("li"),r=document.createElement("a");if(r.title="open original",r.href=n.object.id,r.target="_blank",r.rel="noreferrer nofollow noopener",c.innerHTML=l(n.object.content||"",u),n.object.attachment.forEach(v=>{const f=document.createElement("div");f.innerHTML=l(v.name||"",u)||"Media with no provided descriptive text",c.appendChild(f)}),n.object.summary){const v=document.createElement("details"),f=document.createElement("summary");f.innerHTML=n.object.summary.replaceAll(u,`<mark>${u}</mark>`),v.innerHTML=c.innerHTML,c.textContent="",v.prepend(f),v.open=!0,c.appendChild(v)}const p=document.createElement("time");p.textContent=new Date(n.object.published).toDateString(),p.dateTime=n.object.published,r.appendChild(p),c.prepend(r),t.appendChild(c)})}catch(s){let n="unknown error";s instanceof Error&&(n=s.message),z("Failed to search",s),t.innerHTML=`<li class="null error">Failed to search: ${n||"unknown error"}</li>`}},m=E("outbox");m&&h(m),o.addEventListener("change",async()=>{var n;const u=(n=o.files)==null?void 0:n[0];if(!u)return;const s=JSON.parse(await u.text());h(s)}),a.addEventListener("input",()=>{d(a.value)})})();
