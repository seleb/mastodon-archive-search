import{e as j}from"./index-rZ2YELwX.js";import{get as q,set as P}from"./Storage-C-FqzNcg.js";const R="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let A=(n=21)=>{let r="",t=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)r+=R[t[n]&63];return r};const U=()=>{},T=()=>U;function N(n){const r=document.createElement("li"),t=document.createElement("a");if(t.title="open original",t.href=n.object.id,t.target="_blank",t.rel="noreferrer nofollow noopener",r.innerHTML=n.object.content||"",n.object.attachment.forEach(a=>{const c=document.createElement("div");c.innerHTML=a.name||"",c.innerHTML||(c.textContent="Media with no provided descriptive text"),r.appendChild(c)}),n.object.summary){const a=document.createElement("details"),c=document.createElement("summary");c.innerHTML=n.object.summary||"",a.innerHTML=r.innerHTML,r.textContent="",a.prepend(c),a.open=!0,r.appendChild(a)}const e=document.createElement("time");return e.textContent=new Date(n.object.published).toDateString(),e.dateTime=n.object.published,t.appendChild(e),r.prepend(t),r}var W=function(){function n(){}var r=n.prototype;return r.expandToken=function(e){for(var a=[],c="",i=0,f=e.length;i<f;++i)c+=e.charAt(i),a.push(c);return a},n}(),B=function(){function n(){}var r=n.prototype;return r.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},n}();function $(n,r){r=r||[],n=n||{};for(var t=n,e=0;e<r.length;e++)if(t=t[r[e]],t==null)return null;return t}var G=function(){function n(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var r=n.prototype;return r.indexDocument=function(e,a,c){this._tokenToIdfCache={};var i=this._tokenMap,f;typeof i[e]!="object"?i[e]=f={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(f=i[e],f.$totalNumOccurrences++);var m=f.$uidMap;typeof m[a]!="object"?(f.$numDocumentOccurrences++,m[a]={$document:c,$numTokenOccurrences:1}):m[a].$numTokenOccurrences++},r.search=function(e,a){for(var c={},i=0,f=e.length;i<f;i++){var m=e[i],y=this._tokenMap[m];if(!y)return[];if(i===0)for(var g=Object.keys(y.$uidMap),v=0,x=g.length;v<x;v++){var h=g[v];c[h]=y.$uidMap[h].$document}else for(var g=Object.keys(c),v=0,x=g.length;v<x;v++){var h=g[v];typeof y.$uidMap[h]!="object"&&delete c[h]}}var _=[];for(var h in c)_.push(c[h]);var l=this._createCalculateTfIdf();return _.sort(function(o,s){return l(e,s,a)-l(e,o,a)})},r._createCalculateIdf=function(){var e=this._tokenMap,a=this._tokenToIdfCache;return function(i,f){if(!a[i]){var m=typeof e[i]<"u"?e[i].$numDocumentOccurrences:0;a[i]=1+Math.log(f.length/(1+m))}return a[i]}},r._createCalculateTfIdf=function(){var e=this._tokenMap,a=this._uidFieldName,c=this._createCalculateIdf();return function(f,m,y){for(var g=0,v=0,x=f.length;v<x;++v){var h=f[v],_=c(h,y);_===1/0&&(_=0);var l;a instanceof Array?l=m&&$(m,a):l=m&&m[a];var o=typeof e[h]<"u"&&typeof e[h].$uidMap[l]<"u"?e[h].$uidMap[l].$numTokenOccurrences:0;g+=o*_}return g}},n}(),J=/[^a-zа-яё0-9\-']+/i,K=function(){function n(){}var r=n.prototype;return r.tokenize=function(e){return e.split(J).filter(function(a){return a})},n}();function F(n,r){for(var t=0;t<r.length;t++){var e=r[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}function X(n,r,t){return r&&F(n.prototype,r),t&&F(n,t),n}var O=function(){function n(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new W,this._searchIndex=new G(t),this._sanitizer=new B,this._tokenizer=new K,this._documents=[],this._searchableFields=[]}var r=n.prototype;return r.addDocument=function(e){this.addDocuments([e])},r.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},r.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},r.search=function(e){var a=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(a,this._documents)},r.indexDocuments_=function(e,a){this._initialized=!0;for(var c=this._indexStrategy,i=this._sanitizer,f=this._searchIndex,m=this._tokenizer,y=this._uidFieldName,g=0,v=e.length;g<v;g++){var x=e[g],h;y instanceof Array?h=$(x,y):h=x[y];for(var _=0,l=a.length;_<l;_++){var o,s=a[_];if(s instanceof Array?o=$(x,s):o=x[s],o!=null&&typeof o!="string"&&o.toString&&(o=o.toString()),typeof o=="string")for(var d=m.tokenize(i.sanitize(o)),u=0,w=d.length;u<w;u++)for(var I=d[u],z=c.expandToken(I),k=0,E=z.length;k<E;k++){var M=z[k];f.indexDocument(M,h,x)}}}},X(n,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),n}();const D={tokenize(n){return n.split(/\s/).filter(r=>r)}};function Q(n){return new Worker(""+new URL("worker-D3RxTfxp.js",import.meta.url).href,{name:n==null?void 0:n.name})}const p={setUid(){throw new Error("Function not implemented.")},clear(){throw new Error("Function not implemented.")},addIndex(){throw new Error("Function not implemented.")},addDocuments(){throw new Error("Function not implemented.")},search(){throw new Error("Function not implemented.")}};let C;if(window.Worker){const n=new Q,r=t=>{const e=A();return n.postMessage({id:e,...t}),new Promise(a=>{const c=i=>{e===i.data.id&&(n.removeEventListener("message",c),a(i.data.data))};n.addEventListener("message",c)})};p.setUid=(...t)=>r({fn:"setUid",data:C=t}),p.clear=()=>r({fn:"setUid",data:C}),p.addIndex=(...t)=>r({fn:"addIndex",data:t}),p.addDocuments=(...t)=>r({fn:"addDocuments",data:t}),p.search=(...t)=>r({fn:"search",data:t})}else{let n;p.setUid=(...r)=>(n=new O(...C=r),n.tokenizer=D,Promise.resolve()),p.clear=()=>(n=new O(...C),n.tokenizer=D,Promise.resolve()),p.addIndex=(...r)=>Promise.resolve(n.addIndex(...r)),p.addDocuments=(...r)=>Promise.resolve(n.addDocuments(...r)),p.search=(...r)=>Promise.resolve(n.search(...r))}function H(n,r,t){return n.replace(new RegExp(`(${r.map(e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),t)}async function V(){const n=document.querySelector('input[type="file"]'),r=document.querySelector('input[type="search"]'),t=document.querySelector("select"),e=document.querySelector("#results"),a=document.querySelector("#stats"),c=document.querySelector("#controls");let i=null;if(!n||!r||!t||!e||!a||!c)throw new Error("could not find elements");await p.setUid("id");const f=async l=>{var o;c.classList.add("loading");try{const s=l.orderedItems.filter(u=>u.type==="Create"&&typeof u.object!="string"&&u.object.type==="Note").map(u=>({...u,object:{...u.object,alt:u.object.attachment.map(w=>w.name).join("|")}}));if(!s.length)throw new Error("could not find any posts, double check that your outbox file is correct");const d=((o=s[s.length-1])==null?void 0:o.object.published)||0;a.innerHTML=`<span id="count">0</span> of ${s.length} posts, latest: <time datatime="${d}">${new Date(d).toDateString()}</time>`,i=document.querySelector("#count"),await p.clear(),await Promise.all([p.addIndex(["object","content"]),p.addIndex(["object","summary"]),p.addIndex(["object","alt"])]),await p.addDocuments(s),P("outbox",l),r.value="",await h()}catch(s){let d="unknown error";s instanceof Error&&(d=s.message),j("Failed to load outbox",s),e.innerHTML=`<li class="null error">Failed to load outbox: ${d||"unknown error"}</li>`}finally{c.classList.remove("loading")}};function m(l,o){const s=[],d=/^\s*$/;function u(w){if(w.nodeType==3)(o||!d.test(w.nodeValue||""))&&s.push(w);else for(var I=0,z=w.childNodes.length;I<z;++I)u(w.childNodes[I])}return u(l),s}const y=document.createElement("div"),g=(l,o)=>{l.forEach(s=>{const d=s.textContent,u=o(d||"");d!==u&&(y.innerHTML=u,s.replaceWith(...Array.from(y.childNodes)))})},v=(l,o)=>{const s=D.tokenize(o);let d=m(l,!0);g(d,u=>H(u,[o],'<mark class="exact">$1</mark>')),d=m(l,!0).filter(u=>u.textContent!==o),g(d,u=>H(u,s,"<mark>$1</mark>"))};let x="";const h=async()=>{const l=x=A();try{const o=r.value;if(o.length<1){e.innerHTML='<li class="null">Search results will be displayed here</li>',i&&(i.textContent="0");return}const s=T("search");e.classList.add("stale");const d=await p.search(o);if(s(),l!==x)return;if(!d.length){e.innerHTML=`<li class="null">No results found for search "${o}"</li>`,i&&(i.textContent="0");return}const u=T("sort"),w=t.value;w==="latest first"?d.sort((b,S)=>S.published.localeCompare(b.published)):w==="oldest first"&&d.sort((b,S)=>b.published.localeCompare(S.published)),u();const I=d.slice(0,50),z=T("build"),k=document.createDocumentFragment();I.map(N).forEach(k.appendChild.bind(k)),z();const E=T("highlight");Array.from(k.children).forEach(b=>{v(b,o)}),E();const M=T("render");e.replaceChildren(k),i&&(i.textContent=d.length.toString(10)),M();const L=()=>{if(l!==x)return;const b=d[I.length];if(!b)return;I.push(b);const S=N(b);v(S,o),e.appendChild(S),requestIdleCallback(L)};requestIdleCallback(L)}catch(o){let s="unknown error";o instanceof Error&&(s=o.message),j("Failed to search",o),e.innerHTML=`<li class="null error">Failed to search: ${s||"unknown error"}</li>`}finally{e.classList.remove("stale")}},_=q("outbox");_&&f(_),n.addEventListener("change",async()=>{var s;const l=(s=n.files)==null?void 0:s[0];if(!l)return;const o=JSON.parse(await l.text());f(o)}),r.addEventListener("input",h),t.addEventListener("change",h)}export{V as init};
