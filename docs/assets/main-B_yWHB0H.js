import{get as E,set as j}from"./Storage-DoUUN3Xf.js";import{e as z}from"./index-CrAG5X_o.js";var D=function(){function i(){}var r=i.prototype;return r.expandToken=function(e){for(var a=[],h="",u=0,f=e.length;u<f;++u)h+=e.charAt(u),a.push(h);return a},i}(),C=function(){function i(){}var r=i.prototype;return r.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},i}();function x(i,r){r=r||[],i=i||{};for(var t=i,e=0;e<r.length;e++)if(t=t[r[e]],t==null)return null;return t}var L=function(){function i(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var r=i.prototype;return r.indexDocument=function(e,a,h){this._tokenToIdfCache={};var u=this._tokenMap,f;typeof u[e]!="object"?u[e]=f={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(f=u[e],f.$totalNumOccurrences++);var o=f.$uidMap;typeof o[a]!="object"?(f.$numDocumentOccurrences++,o[a]={$document:h,$numTokenOccurrences:1}):o[a].$numTokenOccurrences++},r.search=function(e,a){for(var h={},u=0,f=e.length;u<f;u++){var o=e[u],l=this._tokenMap[o];if(!l)return[];if(u===0)for(var n=Object.keys(l.$uidMap),c=0,s=n.length;c<s;c++){var d=n[c];h[d]=l.$uidMap[d].$document}else for(var n=Object.keys(h),c=0,s=n.length;c<s;c++){var d=n[c];typeof l.$uidMap[d]!="object"&&delete h[d]}}var m=[];for(var d in h)m.push(h[d]);var p=this._createCalculateTfIdf();return m.sort(function(v,_){return p(e,_,a)-p(e,v,a)})},r._createCalculateIdf=function(){var e=this._tokenMap,a=this._tokenToIdfCache;return function(u,f){if(!a[u]){var o=typeof e[u]<"u"?e[u].$numDocumentOccurrences:0;a[u]=1+Math.log(f.length/(1+o))}return a[u]}},r._createCalculateTfIdf=function(){var e=this._tokenMap,a=this._uidFieldName,h=this._createCalculateIdf();return function(f,o,l){for(var n=0,c=0,s=f.length;c<s;++c){var d=f[c],m=h(d,l);m===1/0&&(m=0);var p;a instanceof Array?p=o&&x(o,a):p=o&&o[a];var v=typeof e[d]<"u"&&typeof e[d].$uidMap[p]<"u"?e[d].$uidMap[p].$numTokenOccurrences:0;n+=v*m}return n}},i}(),O=/[^a-zа-яё0-9\-']+/i,N=function(){function i(){}var r=i.prototype;return r.tokenize=function(e){return e.split(O).filter(function(a){return a})},i}();function k(i,r){for(var t=0;t<r.length;t++){var e=r[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}function H(i,r,t){return r&&k(i.prototype,r),t&&k(i,t),i}var S=function(){function i(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new D,this._searchIndex=new L(t),this._sanitizer=new C,this._tokenizer=new N,this._documents=[],this._searchableFields=[]}var r=i.prototype;return r.addDocument=function(e){this.addDocuments([e])},r.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},r.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},r.search=function(e){var a=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(a,this._documents)},r.indexDocuments_=function(e,a){this._initialized=!0;for(var h=this._indexStrategy,u=this._sanitizer,f=this._searchIndex,o=this._tokenizer,l=this._uidFieldName,n=0,c=e.length;n<c;n++){var s=e[n],d;l instanceof Array?d=x(s,l):d=s[l];for(var m=0,p=a.length;m<p;m++){var v,_=a[m];if(_ instanceof Array?v=x(s,_):v=s[_],v!=null&&typeof v!="string"&&v.toString&&(v=v.toString()),typeof v=="string")for(var I=o.tokenize(u.sanitize(v)),y=0,T=I.length;y<T;y++)for(var w=I[y],b=h.expandToken(w),g=0,M=b.length;g<M;g++){var $=b[g];f.indexDocument($,d,s)}}}},H(i,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),i}();(async()=>{const i=document.querySelector('input[type="file"]'),r=document.querySelector('input[type="text"]'),t=document.querySelector("#results"),e=document.querySelector("#stats");if(!i||!r||!t||!e)throw new Error("could not find elements");let a=new S("id");const h=o=>{var l;try{const n=o.orderedItems.filter(s=>s.type==="Create"&&typeof s.object!="string"&&s.object.type==="Note").map(s=>({...s,object:{...s.object,alt:s.object.attachment.map(d=>d.name).join("|")}}));if(!n.length)throw new Error("could not find any posts, double check that your outbox file is correct");const c=((l=n[n.length-1])==null?void 0:l.object.published)||0;e.innerHTML=`${n.length} posts, latest: <time datatime="${c}">${new Date(c).toDateString()}</time>`,a=new S("id"),a.addIndex(["object","content"]),a.addIndex(["object","summary"]),a.addIndex(["object","alt"]),a.addDocuments(n),j("outbox",o),r.value="",u("")}catch(n){let c="unknown error";n instanceof Error&&(c=n.message),z("Failed to load outbox",n),t.innerHTML=`<li class="null error">Failed to load outbox: ${c||"unknown error"}</li>`}},u=o=>{try{if(Array.from(t.children).forEach(n=>n.remove()),o.length<3){t.innerHTML='<li class="null">Search results will be displayed here</li>';return}const l=a.search(o);if(!l.length){t.innerHTML=`<li class="null">No results found for search "${o}"</li>`;return}l.forEach(n=>{const c=document.createElement("li"),s=document.createElement("a");if(s.title="open original",s.href=n.object.id,s.target="_blank",s.rel="noreferrer nofollow noopener",c.innerHTML=n.object.content.replaceAll(o,`<mark>${o}</mark>`),n.object.attachment.forEach(m=>{const p=document.createElement("img");p.alt=m.name||"Media with no provided descriptive text",c.appendChild(p)}),n.object.summary){const m=document.createElement("details"),p=document.createElement("summary");p.innerHTML=n.object.summary.replaceAll(o,`<mark>${o}</mark>`),m.innerHTML=c.innerHTML,c.textContent="",m.prepend(p),m.open=!0,c.appendChild(m)}const d=document.createElement("time");d.textContent=new Date(n.object.published).toDateString(),d.dateTime=n.object.published,s.appendChild(d),c.prepend(s),t.appendChild(c)})}catch(l){let n="unknown error";l instanceof Error&&(n=l.message),z("Failed to search",l),t.innerHTML=`<li class="null error">Failed to search: ${n||"unknown error"}</li>`}},f=E("outbox");f&&h(f),i.addEventListener("change",async()=>{var n;const o=(n=i.files)==null?void 0:n[0];if(!o)return;const l=JSON.parse(await o.text());h(l)}),r.addEventListener("input",()=>{u(r.value)})})();
