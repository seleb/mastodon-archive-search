import{get as C,set as j}from"./Storage-By1WcDH5.js";import{e as T}from"./index-8hAtDXq_.js";var D=function(){function s(){}var o=s.prototype;return o.expandToken=function(e){for(var u=[],l="",d=0,h=e.length;d<h;++d)l+=e.charAt(d),u.push(l);return u},s}(),L=function(){function s(){}var o=s.prototype;return o.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},s}();function I(s,o){o=o||[],s=s||{};for(var n=s,e=0;e<o.length;e++)if(n=n[o[e]],n==null)return null;return n}var N=function(){function s(n){this._uidFieldName=n,this._tokenToIdfCache={},this._tokenMap={}}var o=s.prototype;return o.indexDocument=function(e,u,l){this._tokenToIdfCache={};var d=this._tokenMap,h;typeof d[e]!="object"?d[e]=h={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(h=d[e],h.$totalNumOccurrences++);var m=h.$uidMap;typeof m[u]!="object"?(h.$numDocumentOccurrences++,m[u]={$document:l,$numTokenOccurrences:1}):m[u].$numTokenOccurrences++},o.search=function(e,u){for(var l={},d=0,h=e.length;d<h;d++){var m=e[d],g=this._tokenMap[m];if(!g)return[];if(d===0)for(var p=Object.keys(g.$uidMap),v=0,i=p.length;v<i;v++){var a=p[v];l[a]=g.$uidMap[a].$document}else for(var p=Object.keys(l),v=0,i=p.length;v<i;v++){var a=p[v];typeof g.$uidMap[a]!="object"&&delete l[a]}}var c=[];for(var a in l)c.push(l[a]);var r=this._createCalculateTfIdf();return c.sort(function(t,f){return r(e,f,u)-r(e,t,u)})},o._createCalculateIdf=function(){var e=this._tokenMap,u=this._tokenToIdfCache;return function(d,h){if(!u[d]){var m=typeof e[d]<"u"?e[d].$numDocumentOccurrences:0;u[d]=1+Math.log(h.length/(1+m))}return u[d]}},o._createCalculateTfIdf=function(){var e=this._tokenMap,u=this._uidFieldName,l=this._createCalculateIdf();return function(h,m,g){for(var p=0,v=0,i=h.length;v<i;++v){var a=h[v],c=l(a,g);c===1/0&&(c=0);var r;u instanceof Array?r=m&&I(m,u):r=m&&m[u];var t=typeof e[a]<"u"&&typeof e[a].$uidMap[r]<"u"?e[a].$uidMap[r].$numTokenOccurrences:0;p+=t*c}return p}},s}(),O=/[^a-zа-яё0-9\-']+/i,H=function(){function s(){}var o=s.prototype;return o.tokenize=function(e){return e.split(O).filter(function(u){return u})},s}();function k(s,o){for(var n=0;n<o.length;n++){var e=o[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(s,e.key,e)}}function F(s,o,n){return o&&k(s.prototype,o),n&&k(s,n),s}var S=function(){function s(n){if(!n)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=n,this._indexStrategy=new D,this._searchIndex=new N(n),this._sanitizer=new L,this._tokenizer=new H,this._documents=[],this._searchableFields=[]}var o=s.prototype;return o.addDocument=function(e){this.addDocuments([e])},o.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},o.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},o.search=function(e){var u=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(u,this._documents)},o.indexDocuments_=function(e,u){this._initialized=!0;for(var l=this._indexStrategy,d=this._sanitizer,h=this._searchIndex,m=this._tokenizer,g=this._uidFieldName,p=0,v=e.length;p<v;p++){var i=e[p],a;g instanceof Array?a=I(i,g):a=i[g];for(var c=0,r=u.length;c<r;c++){var t,f=u[c];if(f instanceof Array?t=I(i,f):t=i[f],t!=null&&typeof t!="string"&&t.toString&&(t=t.toString()),typeof t=="string")for(var x=m.tokenize(d.sanitize(t)),_=0,y=x.length;_<y;_++)for(var $=x[_],z=l.expandToken($),b=0,M=z.length;b<M;b++){var E=z[b];h.indexDocument(E,a,i)}}}},F(s,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),s}();function w(s,o,n){return s.replace(new RegExp(`(${o.map(e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),n)}(async()=>{const s=document.querySelector('input[type="file"]'),o=document.querySelector('input[type="search"]'),n=document.querySelector("select"),e=document.querySelector("#results"),u=document.querySelector("#stats");if(!s||!o||!n||!e||!u)throw new Error("could not find elements");let l=new S("id");const d=i=>{var a;try{const c=i.orderedItems.filter(t=>t.type==="Create"&&typeof t.object!="string"&&t.object.type==="Note").map(t=>({...t,object:{...t.object,alt:t.object.attachment.map(f=>f.name).join("|")}}));if(!c.length)throw new Error("could not find any posts, double check that your outbox file is correct");const r=((a=c[c.length-1])==null?void 0:a.object.published)||0;u.innerHTML=`${c.length} posts, latest: <time datatime="${r}">${new Date(r).toDateString()}</time>`,l=new S("id"),l.tokenizer={tokenize(t){return t.split(/\s/).filter(f=>f)}},l.addIndex(["object","content"]),l.addIndex(["object","summary"]),l.addIndex(["object","alt"]),l.addDocuments(c),j("outbox",i),o.value="",p()}catch(c){let r="unknown error";c instanceof Error&&(r=c.message),T("Failed to load outbox",c),e.innerHTML=`<li class="null error">Failed to load outbox: ${r||"unknown error"}</li>`}};function h(i,a){const c=[],r=/^\s*$/;function t(f){if(f.nodeType==3)(a||!r.test(f.nodeValue||""))&&c.push(f);else for(var x=0,_=f.childNodes.length;x<_;++x)t(f.childNodes[x])}return t(i),c}const m=(i,a)=>{i.forEach(c=>{const r=c.textContent,t=a(r||""),f=document.createRange().createContextualFragment(t);c.replaceWith(f)})},g=(i,a)=>{const c=l.tokenizer.tokenize(a);let r=h(i,!0);m(r,t=>w(t,[a],'<mark class="exact">$1</mark>')),r=h(i,!0),m(r,t=>w(t,c,"<mark>$1</mark>"))},p=()=>{try{const i=o.value;if(Array.from(e.children).forEach(r=>r.remove()),i.length<3){e.innerHTML='<li class="null">Search results will be displayed here</li>';return}const a=l.search(i);if(!a.length){e.innerHTML=`<li class="null">No results found for search "${i}"</li>`;return}const c=n.value;c==="latest first"?a.sort((r,t)=>t.published.localeCompare(r.published)):c==="oldest first"&&a.sort((r,t)=>r.published.localeCompare(t.published)),a.forEach(r=>{const t=document.createElement("li"),f=document.createElement("a");if(f.title="open original",f.href=r.object.id,f.target="_blank",f.rel="noreferrer nofollow noopener",t.innerHTML=r.object.content||"",g(t,i),r.object.attachment.forEach(_=>{const y=document.createElement("div");y.innerHTML=_.name||"",g(y,i),y.innerHTML=y.innerHTML||"Media with no provided descriptive text",t.appendChild(y)}),r.object.summary){const _=document.createElement("details"),y=document.createElement("summary");y.innerHTML=r.object.summary||"",g(y,i),_.innerHTML=t.innerHTML,t.textContent="",_.prepend(y),_.open=!0,t.appendChild(_)}const x=document.createElement("time");x.textContent=new Date(r.object.published).toDateString(),x.dateTime=r.object.published,f.appendChild(x),t.prepend(f),e.appendChild(t)})}catch(i){let a="unknown error";i instanceof Error&&(a=i.message),T("Failed to search",i),e.innerHTML=`<li class="null error">Failed to search: ${a||"unknown error"}</li>`}},v=C("outbox");v&&d(v),s.addEventListener("change",async()=>{var c;const i=(c=s.files)==null?void 0:c[0];if(!i)return;const a=JSON.parse(await i.text());d(a)}),o.addEventListener("input",p),n.addEventListener("change",p)})();
