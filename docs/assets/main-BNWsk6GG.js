import{get as j,set as C}from"./Storage-C7uoPo8g.js";import{e as z}from"./index-D06LNC64.js";var D=function(){function i(){}var r=i.prototype;return r.expandToken=function(e){for(var u=[],d="",l=0,f=e.length;l<f;++l)d+=e.charAt(l),u.push(d);return u},i}(),L=function(){function i(){}var r=i.prototype;return r.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},i}();function b(i,r){r=r||[],i=i||{};for(var t=i,e=0;e<r.length;e++)if(t=t[r[e]],t==null)return null;return t}var O=function(){function i(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var r=i.prototype;return r.indexDocument=function(e,u,d){this._tokenToIdfCache={};var l=this._tokenMap,f;typeof l[e]!="object"?l[e]=f={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(f=l[e],f.$totalNumOccurrences++);var h=f.$uidMap;typeof h[u]!="object"?(f.$numDocumentOccurrences++,h[u]={$document:d,$numTokenOccurrences:1}):h[u].$numTokenOccurrences++},r.search=function(e,u){for(var d={},l=0,f=e.length;l<f;l++){var h=e[l],v=this._tokenMap[h];if(!v)return[];if(l===0)for(var o=Object.keys(v.$uidMap),c=0,s=o.length;c<s;c++){var n=o[c];d[n]=v.$uidMap[n].$document}else for(var o=Object.keys(d),c=0,s=o.length;c<s;c++){var n=o[c];typeof v.$uidMap[n]!="object"&&delete d[n]}}var a=[];for(var n in d)a.push(d[n]);var m=this._createCalculateTfIdf();return a.sort(function(p,_){return m(e,_,u)-m(e,p,u)})},r._createCalculateIdf=function(){var e=this._tokenMap,u=this._tokenToIdfCache;return function(l,f){if(!u[l]){var h=typeof e[l]<"u"?e[l].$numDocumentOccurrences:0;u[l]=1+Math.log(f.length/(1+h))}return u[l]}},r._createCalculateTfIdf=function(){var e=this._tokenMap,u=this._uidFieldName,d=this._createCalculateIdf();return function(f,h,v){for(var o=0,c=0,s=f.length;c<s;++c){var n=f[c],a=d(n,v);a===1/0&&(a=0);var m;u instanceof Array?m=h&&b(h,u):m=h&&h[u];var p=typeof e[n]<"u"&&typeof e[n].$uidMap[m]<"u"?e[n].$uidMap[m].$numTokenOccurrences:0;o+=p*a}return o}},i}(),H=/[^a-zа-яё0-9\-']+/i,N=function(){function i(){}var r=i.prototype;return r.tokenize=function(e){return e.split(H).filter(function(u){return u})},i}();function k(i,r){for(var t=0;t<r.length;t++){var e=r[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}function F(i,r,t){return r&&k(i.prototype,r),t&&k(i,t),i}var S=function(){function i(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new D,this._searchIndex=new O(t),this._sanitizer=new L,this._tokenizer=new N,this._documents=[],this._searchableFields=[]}var r=i.prototype;return r.addDocument=function(e){this.addDocuments([e])},r.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},r.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},r.search=function(e){var u=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(u,this._documents)},r.indexDocuments_=function(e,u){this._initialized=!0;for(var d=this._indexStrategy,l=this._sanitizer,f=this._searchIndex,h=this._tokenizer,v=this._uidFieldName,o=0,c=e.length;o<c;o++){var s=e[o],n;v instanceof Array?n=b(s,v):n=s[v];for(var a=0,m=u.length;a<m;a++){var p,_=u[a];if(_ instanceof Array?p=b(s,_):p=s[_],p!=null&&typeof p!="string"&&p.toString&&(p=p.toString()),typeof p=="string")for(var g=h.tokenize(l.sanitize(p)),y=0,w=g.length;y<w;y++)for(var $=g[y],I=d.expandToken($),x=0,M=I.length;x<M;x++){var E=I[x];f.indexDocument(E,n,s)}}}},F(i,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),i}();function T(i,r,t){return i.replace(new RegExp(`(${r.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")})`,"ig"),t)}(async()=>{const i=document.querySelector('input[type="file"]'),r=document.querySelector('input[type="search"]'),t=document.querySelector("select"),e=document.querySelector("#results"),u=document.querySelector("#stats");if(!i||!r||!t||!e||!u)throw new Error("could not find elements");let d=new S("id");const l=o=>{var c;try{const s=o.orderedItems.filter(a=>a.type==="Create"&&typeof a.object!="string"&&a.object.type==="Note").map(a=>({...a,object:{...a.object,alt:a.object.attachment.map(m=>m.name).join("|")}}));if(!s.length)throw new Error("could not find any posts, double check that your outbox file is correct");const n=((c=s[s.length-1])==null?void 0:c.object.published)||0;u.innerHTML=`${s.length} posts, latest: <time datatime="${n}">${new Date(n).toDateString()}</time>`,d=new S("id"),d.addIndex(["object","content"]),d.addIndex(["object","summary"]),d.addIndex(["object","alt"]),d.addDocuments(s),C("outbox",o),r.value="",h()}catch(s){let n="unknown error";s instanceof Error&&(n=s.message),z("Failed to load outbox",s),e.innerHTML=`<li class="null error">Failed to load outbox: ${n||"unknown error"}</li>`}},f=(o,c)=>{const s=d.tokenizer.tokenize(c);let n=T(o,c,'<mark class="exact">$1</mark>');return s.forEach(a=>{n=T(n,a,"<mark>$1</mark>")}),n},h=()=>{try{const o=r.value;if(Array.from(e.children).forEach(n=>n.remove()),o.length<3){e.innerHTML='<li class="null">Search results will be displayed here</li>';return}const c=d.search(o);if(!c.length){e.innerHTML=`<li class="null">No results found for search "${o}"</li>`;return}const s=t.value;s==="latest first"?c.sort((n,a)=>a.published.localeCompare(n.published)):s==="oldest first"&&c.sort((n,a)=>n.published.localeCompare(a.published)),c.forEach(n=>{const a=document.createElement("li"),m=document.createElement("a");if(m.title="open original",m.href=n.object.id,m.target="_blank",m.rel="noreferrer nofollow noopener",a.innerHTML=f(n.object.content||"",o),n.object.attachment.forEach(_=>{const g=document.createElement("div");g.innerHTML=f(_.name||"",o)||"Media with no provided descriptive text",a.appendChild(g)}),n.object.summary){const _=document.createElement("details"),g=document.createElement("summary");g.innerHTML=f(n.object.summary||"",o),_.innerHTML=a.innerHTML,a.textContent="",_.prepend(g),_.open=!0,a.appendChild(_)}const p=document.createElement("time");p.textContent=new Date(n.object.published).toDateString(),p.dateTime=n.object.published,m.appendChild(p),a.prepend(m),e.appendChild(a)})}catch(o){let c="unknown error";o instanceof Error&&(c=o.message),z("Failed to search",o),e.innerHTML=`<li class="null error">Failed to search: ${c||"unknown error"}</li>`}},v=j("outbox");v&&l(v),i.addEventListener("change",async()=>{var s;const o=(s=i.files)==null?void 0:s[0];if(!o)return;const c=JSON.parse(await o.text());l(c)}),r.addEventListener("input",h),t.addEventListener("change",h)})();
