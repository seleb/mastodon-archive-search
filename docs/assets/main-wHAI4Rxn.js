import{get as j,set as D}from"./Storage-BrypPhGa.js";import{e as z}from"./index-CQVV5ysy.js";var E=function(){function i(){}var r=i.prototype;return r.expandToken=function(e){for(var a=[],h="",s=0,f=e.length;s<f;++s)h+=e.charAt(s),a.push(h);return a},i}(),C=function(){function i(){}var r=i.prototype;return r.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},i}();function x(i,r){r=r||[],i=i||{};for(var t=i,e=0;e<r.length;e++)if(t=t[r[e]],t==null)return null;return t}var L=function(){function i(t){this._uidFieldName=t,this._tokenToIdfCache={},this._tokenMap={}}var r=i.prototype;return r.indexDocument=function(e,a,h){this._tokenToIdfCache={};var s=this._tokenMap,f;typeof s[e]!="object"?s[e]=f={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(f=s[e],f.$totalNumOccurrences++);var o=f.$uidMap;typeof o[a]!="object"?(f.$numDocumentOccurrences++,o[a]={$document:h,$numTokenOccurrences:1}):o[a].$numTokenOccurrences++},r.search=function(e,a){for(var h={},s=0,f=e.length;s<f;s++){var o=e[s],d=this._tokenMap[o];if(!d)return[];if(s===0)for(var n=Object.keys(d.$uidMap),u=0,c=n.length;u<c;u++){var l=n[u];h[l]=d.$uidMap[l].$document}else for(var n=Object.keys(h),u=0,c=n.length;u<c;u++){var l=n[u];typeof d.$uidMap[l]!="object"&&delete h[l]}}var m=[];for(var l in h)m.push(h[l]);var p=this._createCalculateTfIdf();return m.sort(function(v,_){return p(e,_,a)-p(e,v,a)})},r._createCalculateIdf=function(){var e=this._tokenMap,a=this._tokenToIdfCache;return function(s,f){if(!a[s]){var o=typeof e[s]<"u"?e[s].$numDocumentOccurrences:0;a[s]=1+Math.log(f.length/(1+o))}return a[s]}},r._createCalculateTfIdf=function(){var e=this._tokenMap,a=this._uidFieldName,h=this._createCalculateIdf();return function(f,o,d){for(var n=0,u=0,c=f.length;u<c;++u){var l=f[u],m=h(l,d);m===1/0&&(m=0);var p;a instanceof Array?p=o&&x(o,a):p=o&&o[a];var v=typeof e[l]<"u"&&typeof e[l].$uidMap[p]<"u"?e[l].$uidMap[p].$numTokenOccurrences:0;n+=v*m}return n}},i}(),O=/[^a-zа-яё0-9\-']+/i,N=function(){function i(){}var r=i.prototype;return r.tokenize=function(e){return e.split(O).filter(function(a){return a})},i}();function S(i,r){for(var t=0;t<r.length;t++){var e=r[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}function H(i,r,t){return r&&S(i.prototype,r),t&&S(i,t),i}var k=function(){function i(t){if(!t)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=t,this._indexStrategy=new E,this._searchIndex=new L(t),this._sanitizer=new C,this._tokenizer=new N,this._documents=[],this._searchableFields=[]}var r=i.prototype;return r.addDocument=function(e){this.addDocuments([e])},r.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},r.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},r.search=function(e){var a=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(a,this._documents)},r.indexDocuments_=function(e,a){this._initialized=!0;for(var h=this._indexStrategy,s=this._sanitizer,f=this._searchIndex,o=this._tokenizer,d=this._uidFieldName,n=0,u=e.length;n<u;n++){var c=e[n],l;d instanceof Array?l=x(c,d):l=c[d];for(var m=0,p=a.length;m<p;m++){var v,_=a[m];if(_ instanceof Array?v=x(c,_):v=c[_],v!=null&&typeof v!="string"&&v.toString&&(v=v.toString()),typeof v=="string")for(var I=o.tokenize(s.sanitize(v)),y=0,T=I.length;y<T;y++)for(var w=I[y],b=h.expandToken(w),g=0,M=b.length;g<M;g++){var $=b[g];f.indexDocument($,l,c)}}}},H(i,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),i}();(async()=>{const i=document.querySelector('input[type="file"]'),r=document.querySelector('input[type="text"]'),t=document.querySelector("#results"),e=document.querySelector("#stats");if(!i||!r||!t||!e)throw new Error("could not find elements");let a=new k("id");const h=o=>{var d;try{const n=o.orderedItems.filter(c=>c.type==="Create"&&typeof c.object!="string"&&c.object.type==="Note").map(c=>({...c,object:{...c.object,alt:c.object.attachment.map(l=>l.name).join("|")}}));if(!n.length)throw new Error("could not find any posts, double check that your outbox file is correct");const u=((d=n[n.length-1])==null?void 0:d.object.published)||0;e.innerHTML=`${n.length} posts, latest: <time datatime="${u}">${new Date(u).toDateString()}</time>`,a=new k("id"),a.addIndex(["object","content"]),a.addIndex(["object","summary"]),a.addIndex(["object","alt"]),a.addDocuments(n),D("outbox",o),r.value="",s("")}catch(n){z("Failed to load outbox",n),t.innerHTML=`<li class="null error">Failed to load outbox: ${n.message||"unknown error"}</li>`}},s=o=>{try{if(Array.from(t.children).forEach(n=>n.remove()),o.length<3){t.innerHTML='<li class="null">Search results will be displayed here</li>';return}const d=a.search(o);if(!d.length){t.innerHTML=`<li class="null">No results found for search "${o}"</li>`;return}d.forEach(n=>{const u=document.createElement("li"),c=document.createElement("a");if(c.title="open original",c.href=n.object.id,c.target="_blank",c.rel="noreferrer nofollow noopener",u.innerHTML=n.object.content.replaceAll(o,`<mark>${o}</mark>`),n.object.attachment.forEach(m=>{const p=document.createElement("img");p.alt=m.name||"Media with no provided descriptive text",u.appendChild(p)}),n.object.summary){const m=document.createElement("details"),p=document.createElement("summary");p.innerHTML=n.object.summary.replaceAll(o,`<mark>${o}</mark>`),m.innerHTML=u.innerHTML,u.textContent="",m.prepend(p),m.open=!0,u.appendChild(m)}const l=document.createElement("time");l.textContent=new Date(n.object.published).toDateString(),l.dateTime=n.object.published,c.appendChild(l),u.prepend(c),t.appendChild(u)})}catch(d){z("Failed to search",d),t.innerHTML=`<li class="null error">Failed to search: ${d.message||"unknown error"}</li>`}},f=j("outbox");f&&h(f),i.addEventListener("change",async()=>{var n;const o=(n=i.files)==null?void 0:n[0];if(!o)return;const d=JSON.parse(await o.text());h(d)}),r.addEventListener("input",()=>{s(r.value)})})();
