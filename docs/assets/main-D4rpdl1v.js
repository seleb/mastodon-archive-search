import{e as L}from"./index-ChBP7r0G.js";import{get as H,set as P}from"./Storage-dcFdvosB.js";const q="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let O=(n=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)t+=q[r[n]&63];return t};const U=()=>{},S=()=>U;function N(n){const t=document.createElement("li"),r=document.createElement("a");r.title="open original",r.href=n.object.id,r.target="_blank",r.rel="noreferrer nofollow noopener";const e=document.createElement("a");e.title="open the post chronologically before this one",e.href=n.prev?.object.id||"",e.target="_blank",e.rel="noreferrer nofollow noopener",e.textContent="⮜";const i=document.createElement("a");if(i.title="open the post chronologically after this one",i.href=n.next?.object.id||"",i.target="_blank",i.rel="noreferrer nofollow noopener",i.textContent="⮞",t.innerHTML=n.object.content||"",n.object.attachment.forEach(o=>{const c=document.createElement("div");c.innerHTML=o.name||"",c.innerHTML||(c.textContent="Media with no provided descriptive text"),t.appendChild(c)}),n.object.summary){const o=document.createElement("details"),c=document.createElement("summary");c.innerHTML=n.object.summary||"",o.innerHTML=t.innerHTML,t.textContent="",o.prepend(c),o.open=!0,t.appendChild(o)}const u=document.createElement("time");return u.textContent=new Date(n.object.published).toDateString(),u.dateTime=n.object.published,r.appendChild(u),i.href&&t.prepend(i),e.href&&t.prepend(e),t.prepend(r),t}var R=(function(){function n(){}var t=n.prototype;return t.expandToken=function(e){for(var i=[],u="",o=0,c=e.length;o<c;++o)u+=e.charAt(o),i.push(u);return i},n})(),W=(function(){function n(){}var t=n.prototype;return t.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},n})();function $(n,t){t=t||[],n=n||{};for(var r=n,e=0;e<t.length;e++)if(r=r[t[e]],r==null)return null;return r}var B=(function(){function n(r){this._uidFieldName=r,this._tokenToIdfCache={},this._tokenMap={}}var t=n.prototype;return t.indexDocument=function(e,i,u){this._tokenToIdfCache={};var o=this._tokenMap,c;typeof o[e]!="object"?o[e]=c={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(c=o[e],c.$totalNumOccurrences++);var p=c.$uidMap;typeof p[i]!="object"?(c.$numDocumentOccurrences++,p[i]={$document:u,$numTokenOccurrences:1}):p[i].$numTokenOccurrences++},t.search=function(e,i){for(var u={},o=0,c=e.length;o<c;o++){var p=e[o],y=this._tokenMap[p];if(!y)return[];if(o===0)for(var g=Object.keys(y.$uidMap),v=0,x=g.length;v<x;v++){var f=g[v];u[f]=y.$uidMap[f].$document}else for(var g=Object.keys(u),v=0,x=g.length;v<x;v++){var f=g[v];typeof y.$uidMap[f]!="object"&&delete u[f]}}var _=[];for(var f in u)_.push(u[f]);var d=this._createCalculateTfIdf();return _.sort(function(a,h){return d(e,h,i)-d(e,a,i)})},t._createCalculateIdf=function(){var e=this._tokenMap,i=this._tokenToIdfCache;return function(o,c){if(!i[o]){var p=typeof e[o]<"u"?e[o].$numDocumentOccurrences:0;i[o]=1+Math.log(c.length/(1+p))}return i[o]}},t._createCalculateTfIdf=function(){var e=this._tokenMap,i=this._uidFieldName,u=this._createCalculateIdf();return function(c,p,y){for(var g=0,v=0,x=c.length;v<x;++v){var f=c[v],_=u(f,y);_===1/0&&(_=0);var d;i instanceof Array?d=p&&$(p,i):d=p&&p[i];var a=typeof e[f]<"u"&&typeof e[f].$uidMap[d]<"u"?e[f].$uidMap[d].$numTokenOccurrences:0;g+=a*_}return g}},n})(),G=/[^a-zа-яё0-9\-']+/i,J=(function(){function n(){}var t=n.prototype;return t.tokenize=function(e){return e.split(G).filter(function(i){return i})},n})();function K(n,t){for(var r=0;r<t.length;r++){var e=t[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}function X(n,t,r){return t&&K(n.prototype,t),n}var A=(function(){function n(r){if(!r)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=r,this._indexStrategy=new R,this._searchIndex=new B(r),this._sanitizer=new W,this._tokenizer=new J,this._documents=[],this._searchableFields=[]}var t=n.prototype;return t.addDocument=function(e){this.addDocuments([e])},t.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},t.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},t.search=function(e){var i=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(i,this._documents)},t.indexDocuments_=function(e,i){this._initialized=!0;for(var u=this._indexStrategy,o=this._sanitizer,c=this._searchIndex,p=this._tokenizer,y=this._uidFieldName,g=0,v=e.length;g<v;g++){var x=e[g],f;y instanceof Array?f=$(x,y):f=x[y];for(var _=0,d=i.length;_<d;_++){var a,h=i[_];if(h instanceof Array?a=$(x,h):a=x[h],a!=null&&typeof a!="string"&&a.toString&&(a=a.toString()),typeof a=="string")for(var s=p.tokenize(o.sanitize(a)),l=0,b=s.length;l<b;l++)for(var k=s[l],T=u.expandToken(k),I=0,E=T.length;I<E;I++){var M=T[I];c.indexDocument(M,f,x)}}}},X(n,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),n})();const j={tokenize(n){return n.replaceAll("&#39;","'").replaceAll("&apos;","'").replaceAll("&quot;",'"').replaceAll("&amp;","&").replaceAll("&lt;","<").replaceAll("&gt;",">").split(/\s/).filter(t=>t)}};function Q(n){return new Worker(""+new URL("worker-C3hBu5Ma.js",import.meta.url).href,{name:n?.name})}const m={setUid(){throw new Error("Function not implemented.")},clear(){throw new Error("Function not implemented.")},addIndex(){throw new Error("Function not implemented.")},addDocuments(){throw new Error("Function not implemented.")},search(){throw new Error("Function not implemented.")}};let C;if(window.Worker){const n=new Q,t=r=>{const e=O();return n.postMessage({id:e,...r}),new Promise(i=>{const u=o=>{e===o.data.id&&(n.removeEventListener("message",u),i(o.data.data))};n.addEventListener("message",u)})};m.setUid=(...r)=>t({fn:"setUid",data:C=r}),m.clear=()=>t({fn:"setUid",data:C}),m.addIndex=(...r)=>t({fn:"addIndex",data:r}),m.addDocuments=(...r)=>t({fn:"addDocuments",data:r}),m.search=(...r)=>t({fn:"search",data:r})}else{let n;m.setUid=(...t)=>(n=new A(...C=t),n.tokenizer=j,Promise.resolve()),m.clear=()=>(n=new A(...C),n.tokenizer=j,Promise.resolve()),m.addIndex=(...t)=>Promise.resolve(n.addIndex(...t)),m.addDocuments=(...t)=>Promise.resolve(n.addDocuments(...t)),m.search=(...t)=>Promise.resolve(n.search(...t))}function F(n,t,r){return n.replace(new RegExp(`(${t.map(e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),r)}async function V(){const n=document.querySelector('input[type="file"]'),t=document.querySelector('input[type="search"]'),r=document.querySelector("select"),e=document.querySelector("#results"),i=document.querySelector("#stats"),u=document.querySelector("#controls");let o=null;if(!n||!t||!r||!e||!i||!u)throw new Error("could not find elements");await m.setUid("id");const c=async d=>{u.classList.add("loading");try{const a=d.orderedItems.filter(s=>s.type==="Create"&&typeof s.object!="string"&&s.object.type==="Note").map(s=>({...s,object:{...s.object,alt:s.object.attachment.map(l=>l.name).join("|"),tags:s.object.tag.map(l=>`${l.name} ${l.name.replace("#","")}`).join(" ")}})).map((s,l,b)=>({...s,prev:b[l-1],next:b[l+1]}));if(!a.length)throw new Error("could not find any posts, double check that your outbox file is correct");const h=a[a.length-1]?.object.published||0;i.innerHTML=`<span id="count">0</span> of ${a.length} posts, latest: <time datatime="${h}">${new Date(h).toDateString()}</time>`,o=document.querySelector("#count"),await m.clear(),await Promise.all([m.addIndex(["object","content"]),m.addIndex(["object","summary"]),m.addIndex(["object","alt"]),m.addIndex(["object","tags"])]),await m.addDocuments(a),P("outbox",d),t.value="",await f()}catch(a){let h="unknown error";a instanceof Error&&(h=a.message),L("Failed to load outbox",a),e.innerHTML=`<li class="null error">Failed to load outbox: ${h||"unknown error"}</li>`}finally{u.classList.remove("loading")}};function p(d,a){const h=[];function s(l){if(l.nodeType==3)h.push(l);else for(var b=0,k=l.childNodes.length;b<k;++b)s(l.childNodes[b])}return s(d),h}const y=document.createElement("div"),g=(d,a)=>{d.forEach(h=>{const s=h.textContent,l=a(s||"");s!==l&&(y.innerHTML=l,h.replaceWith(...Array.from(y.childNodes)))})},v=(d,a)=>{const h=j.tokenize(a);let s=p(d);g(s,l=>F(l,[a],'<mark class="exact">$1</mark>')),s=p(d).filter(l=>l.textContent!==a),g(s,l=>F(l,h,"<mark>$1</mark>"))};let x="";const f=async()=>{const d=x=O();try{const a=t.value;if(a.length<1){e.innerHTML='<li class="null">Search results will be displayed here</li>',o&&(o.textContent="0");return}const h=S("search");e.classList.add("stale");const s=await m.search(a);if(h(),d!==x)return;if(!s.length){e.innerHTML=`<li class="null">No results found for search "${a}"</li>`,o&&(o.textContent="0");return}const l=S("sort"),b=r.value;b==="latest first"?s.sort((w,z)=>z.published.localeCompare(w.published)):b==="oldest first"&&s.sort((w,z)=>w.published.localeCompare(z.published)),l();const k=s.slice(0,50),T=S("build"),I=document.createDocumentFragment();k.map(N).forEach(I.appendChild.bind(I)),T();const E=S("highlight");Array.from(I.children).forEach(w=>{v(w,a)}),E();const M=S("render");e.replaceChildren(I),o&&(o.textContent=s.length.toString(10)),M();const D=()=>{if(d!==x)return;const w=s[k.length];if(!w)return;k.push(w);const z=N(w);v(z,a),e.appendChild(z),requestIdleCallback(D)};requestIdleCallback(D)}catch(a){let h="unknown error";a instanceof Error&&(h=a.message),L("Failed to search",a),e.innerHTML=`<li class="null error">Failed to search: ${h||"unknown error"}</li>`}finally{e.classList.remove("stale")}},_=H("outbox");_&&c(_),n.addEventListener("change",async()=>{const d=n.files?.[0];if(!d)return;const a=JSON.parse(await d.text());c(a)}),t.addEventListener("input",f),r.addEventListener("change",f)}export{V as init};
