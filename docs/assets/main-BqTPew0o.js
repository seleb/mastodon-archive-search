import{e as j}from"./index-B8C5Zc0P.js";import{get as H,set as P}from"./Storage-dcFdvosB.js";const q="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let O=(n=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)t+=q[r[n]&63];return t};const U=()=>{},S=()=>U;function N(n){const t=document.createElement("li"),r=document.createElement("a");r.title="open original",r.href=n.object.id,r.target="_blank",r.rel="noreferrer nofollow noopener";const e=document.createElement("a");e.title="open the post chronologically before this one",e.href=n.prev?.object.id||"",e.target="_blank",e.rel="noreferrer nofollow noopener",e.textContent="⮜";const i=document.createElement("a");if(i.title="open the post chronologically after this one",i.href=n.next?.object.id||"",i.target="_blank",i.rel="noreferrer nofollow noopener",i.textContent="⮞",t.innerHTML=n.object.content||"",n.object.attachment.forEach(a=>{const c=document.createElement("div");c.innerHTML=a.name||"",c.innerHTML||(c.textContent="Media with no provided descriptive text"),t.appendChild(c)}),n.object.summary){const a=document.createElement("details"),c=document.createElement("summary");c.innerHTML=n.object.summary||"",a.innerHTML=t.innerHTML,t.textContent="",a.prepend(c),a.open=!0,t.appendChild(a)}const l=document.createElement("time");return l.textContent=new Date(n.object.published).toDateString(),l.dateTime=n.object.published,r.appendChild(l),i.href&&t.prepend(i),e.href&&t.prepend(e),t.prepend(r),t}var R=(function(){function n(){}var t=n.prototype;return t.expandToken=function(e){for(var i=[],l="",a=0,c=e.length;a<c;++a)l+=e.charAt(a),i.push(l);return i},n})(),W=(function(){function n(){}var t=n.prototype;return t.sanitize=function(e){return e?e.toLocaleLowerCase().trim():""},n})();function $(n,t){t=t||[],n=n||{};for(var r=n,e=0;e<t.length;e++)if(r=r[t[e]],r==null)return null;return r}var B=(function(){function n(r){this._uidFieldName=r,this._tokenToIdfCache={},this._tokenMap={}}var t=n.prototype;return t.indexDocument=function(e,i,l){this._tokenToIdfCache={};var a=this._tokenMap,c;typeof a[e]!="object"?a[e]=c={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(c=a[e],c.$totalNumOccurrences++);var m=c.$uidMap;typeof m[i]!="object"?(c.$numDocumentOccurrences++,m[i]={$document:l,$numTokenOccurrences:1}):m[i].$numTokenOccurrences++},t.search=function(e,i){for(var l={},a=0,c=e.length;a<c;a++){var m=e[a],y=this._tokenMap[m];if(!y)return[];if(a===0)for(var g=Object.keys(y.$uidMap),v=0,x=g.length;v<x;v++){var f=g[v];l[f]=y.$uidMap[f].$document}else for(var g=Object.keys(l),v=0,x=g.length;v<x;v++){var f=g[v];typeof y.$uidMap[f]!="object"&&delete l[f]}}var _=[];for(var f in l)_.push(l[f]);var u=this._createCalculateTfIdf();return _.sort(function(o,d){return u(e,d,i)-u(e,o,i)})},t._createCalculateIdf=function(){var e=this._tokenMap,i=this._tokenToIdfCache;return function(a,c){if(!i[a]){var m=typeof e[a]<"u"?e[a].$numDocumentOccurrences:0;i[a]=1+Math.log(c.length/(1+m))}return i[a]}},t._createCalculateTfIdf=function(){var e=this._tokenMap,i=this._uidFieldName,l=this._createCalculateIdf();return function(c,m,y){for(var g=0,v=0,x=c.length;v<x;++v){var f=c[v],_=l(f,y);_===1/0&&(_=0);var u;i instanceof Array?u=m&&$(m,i):u=m&&m[i];var o=typeof e[f]<"u"&&typeof e[f].$uidMap[u]<"u"?e[f].$uidMap[u].$numTokenOccurrences:0;g+=o*_}return g}},n})(),G=/[^a-zа-яё0-9\-']+/i,J=(function(){function n(){}var t=n.prototype;return t.tokenize=function(e){return e.split(G).filter(function(i){return i})},n})();function K(n,t){for(var r=0;r<t.length;r++){var e=t[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}function X(n,t,r){return t&&K(n.prototype,t),n}var A=(function(){function n(r){if(!r)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=r,this._indexStrategy=new R,this._searchIndex=new B(r),this._sanitizer=new W,this._tokenizer=new J,this._documents=[],this._searchableFields=[]}var t=n.prototype;return t.addDocument=function(e){this.addDocuments([e])},t.addDocuments=function(e){this._documents=this._documents.concat(e),this.indexDocuments_(e,this._searchableFields)},t.addIndex=function(e){this._searchableFields.push(e),this.indexDocuments_(this._documents,[e])},t.search=function(e){var i=this._tokenizer.tokenize(this._sanitizer.sanitize(e));return this._searchIndex.search(i,this._documents)},t.indexDocuments_=function(e,i){this._initialized=!0;for(var l=this._indexStrategy,a=this._sanitizer,c=this._searchIndex,m=this._tokenizer,y=this._uidFieldName,g=0,v=e.length;g<v;g++){var x=e[g],f;y instanceof Array?f=$(x,y):f=x[y];for(var _=0,u=i.length;_<u;_++){var o,d=i[_];if(d instanceof Array?o=$(x,d):o=x[d],o!=null&&typeof o!="string"&&o.toString&&(o=o.toString()),typeof o=="string")for(var s=m.tokenize(a.sanitize(o)),h=0,w=s.length;h<w;h++)for(var k=s[h],T=l.expandToken(k),I=0,E=T.length;I<E;I++){var M=T[I];c.indexDocument(M,f,x)}}}},X(n,[{key:"indexStrategy",set:function(e){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=e},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(e){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=e},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(e){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=e},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(e){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=e},get:function(){return this._tokenizer}}]),n})();const D={tokenize(n){return n.replaceAll("&#39;","'").replaceAll("&apos;","'").replaceAll("&quot;",'"').replaceAll("&amp;","&").replaceAll("&lt;","<").replaceAll("&gt;",">").split(/\s/).filter(t=>t)}};function Q(n){return new Worker(""+new URL("worker-C3hBu5Ma.js",import.meta.url).href,{name:n?.name})}const p={setUid(){throw new Error("Function not implemented.")},clear(){throw new Error("Function not implemented.")},addIndex(){throw new Error("Function not implemented.")},addDocuments(){throw new Error("Function not implemented.")},search(){throw new Error("Function not implemented.")}};let C;if(window.Worker){const n=new Q,t=r=>{const e=O();return n.postMessage({id:e,...r}),new Promise(i=>{const l=a=>{e===a.data.id&&(n.removeEventListener("message",l),i(a.data.data))};n.addEventListener("message",l)})};p.setUid=(...r)=>t({fn:"setUid",data:C=r}),p.clear=()=>t({fn:"setUid",data:C}),p.addIndex=(...r)=>t({fn:"addIndex",data:r}),p.addDocuments=(...r)=>t({fn:"addDocuments",data:r}),p.search=(...r)=>t({fn:"search",data:r})}else{let n;p.setUid=(...t)=>(n=new A(...C=t),n.tokenizer=D,Promise.resolve()),p.clear=()=>(n=new A(...C),n.tokenizer=D,Promise.resolve()),p.addIndex=(...t)=>Promise.resolve(n.addIndex(...t)),p.addDocuments=(...t)=>Promise.resolve(n.addDocuments(...t)),p.search=(...t)=>Promise.resolve(n.search(...t))}function F(n,t,r){return n.replace(new RegExp(`(${t.map(e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),r)}async function V(){const n=document.querySelector('input[type="file"]'),t=document.querySelector('input[type="search"]'),r=document.querySelector("select"),e=document.querySelector("#results"),i=document.querySelector("#stats"),l=document.querySelector("#controls");let a=null;if(!n||!t||!r||!e||!i||!l)throw new Error("could not find elements");await p.setUid("id");const c=async u=>{l.classList.add("loading");try{const o=u.orderedItems.filter(s=>s.type==="Create"&&typeof s.object!="string"&&s.object.type==="Note").map(s=>({...s,object:{...s.object,alt:s.object.attachment.map(h=>h.name).join("|")}})).map((s,h,w)=>({...s,prev:w[h-1],next:w[h+1]}));if(!o.length)throw new Error("could not find any posts, double check that your outbox file is correct");const d=o[o.length-1]?.object.published||0;i.innerHTML=`<span id="count">0</span> of ${o.length} posts, latest: <time datatime="${d}">${new Date(d).toDateString()}</time>`,a=document.querySelector("#count"),await p.clear(),await Promise.all([p.addIndex(["object","content"]),p.addIndex(["object","summary"]),p.addIndex(["object","alt"])]),await p.addDocuments(o),P("outbox",u),t.value="",await f()}catch(o){let d="unknown error";o instanceof Error&&(d=o.message),j("Failed to load outbox",o),e.innerHTML=`<li class="null error">Failed to load outbox: ${d||"unknown error"}</li>`}finally{l.classList.remove("loading")}};function m(u,o){const d=[];function s(h){if(h.nodeType==3)d.push(h);else for(var w=0,k=h.childNodes.length;w<k;++w)s(h.childNodes[w])}return s(u),d}const y=document.createElement("div"),g=(u,o)=>{u.forEach(d=>{const s=d.textContent,h=o(s||"");s!==h&&(y.innerHTML=h,d.replaceWith(...Array.from(y.childNodes)))})},v=(u,o)=>{const d=D.tokenize(o);let s=m(u);g(s,h=>F(h,[o],'<mark class="exact">$1</mark>')),s=m(u).filter(h=>h.textContent!==o),g(s,h=>F(h,d,"<mark>$1</mark>"))};let x="";const f=async()=>{const u=x=O();try{const o=t.value;if(o.length<1){e.innerHTML='<li class="null">Search results will be displayed here</li>',a&&(a.textContent="0");return}const d=S("search");e.classList.add("stale");const s=await p.search(o);if(d(),u!==x)return;if(!s.length){e.innerHTML=`<li class="null">No results found for search "${o}"</li>`,a&&(a.textContent="0");return}const h=S("sort"),w=r.value;w==="latest first"?s.sort((b,z)=>z.published.localeCompare(b.published)):w==="oldest first"&&s.sort((b,z)=>b.published.localeCompare(z.published)),h();const k=s.slice(0,50),T=S("build"),I=document.createDocumentFragment();k.map(N).forEach(I.appendChild.bind(I)),T();const E=S("highlight");Array.from(I.children).forEach(b=>{v(b,o)}),E();const M=S("render");e.replaceChildren(I),a&&(a.textContent=s.length.toString(10)),M();const L=()=>{if(u!==x)return;const b=s[k.length];if(!b)return;k.push(b);const z=N(b);v(z,o),e.appendChild(z),requestIdleCallback(L)};requestIdleCallback(L)}catch(o){let d="unknown error";o instanceof Error&&(d=o.message),j("Failed to search",o),e.innerHTML=`<li class="null error">Failed to search: ${d||"unknown error"}</li>`}finally{e.classList.remove("stale")}},_=H("outbox");_&&c(_),n.addEventListener("change",async()=>{const u=n.files?.[0];if(!u)return;const o=JSON.parse(await u.text());c(o)}),t.addEventListener("input",f),r.addEventListener("change",f)}export{V as init};
